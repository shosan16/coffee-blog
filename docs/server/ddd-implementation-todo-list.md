# DDD Implementation TODO List

## ✅ 即座実行タスク（Immediate）- 完了済み

### 🔥 緊急度: 高

- [x] **単体テストの作成** ✅ 完了 (2025-07-15)

  - [x] Recipe.entity.tsのテスト作成
  - [x] Barista.entity.tsのテスト作成
  - [x] Equipment.entity.tsのテスト作成
  - [x] RecipeIdのテスト作成
  - [x] BrewingConditionsのテスト作成
  - 期間: 1-2日

- [x] **品質チェックの実行と修正** ✅ 完了 (2025-07-15)

  - [x] `npm run format`実行とコミット
  - [x] `npm run lint`エラー解消
  - [x] `npx tsc --noEmit`型エラー解消
  - [x] `npm test`全テスト成功確認（565テスト成功、1スキップ）
  - 期間: 0.5日

- [x] **Phase 1完了レビュー** ✅ 完了 (2025-07-15)

  - [x] ドメインモデルの実装内容確認
  - [x] YAGNI原則適用結果の検証
  - [x] コード品質の最終チェック
  - 期間: 0.5日

- [x] **YAGNI原則適用によるコード簡素化** ✅ 完了 (2025-07-19)

  - [x] 未使用メソッド削除（約20個）
  - [x] 不要コード削除（約400行）
  - [x] 複雑さ指数40%削減
  - [x] 対応するテストファイル更新
  - [x] テスト環境設定修正（jsdom環境、scrollIntoViewモック追加）
  - [x] 全テスト正常化（554テスト成功、1スキップ）
  - 期間: 0.5日

- [x] **テスト品質向上とテスト環境最適化** ✅ 完了 (2025-07-19)
  - [x] フロントエンドテスト環境の修正（vitest.config.ts）
  - [x] JSDOMテスト環境の完全セットアップ
  - [x] @testing-library/jest-dom カスタムマッチャーの設定
  - [x] scrollIntoView等のWeb APIモックの追加
  - [x] 全40テストファイル、555テストの正常動作確認
  - 期間: 1日

---

## 📋 Phase 2: リポジトリパターン導入 ✅ 完了 (2025-07-19)

### 優先度: 高

#### Week 1（1-2日目）

- [x] **Prismaリポジトリの実装** ✅ 完了 (2025-07-19)

  - [x] `PrismaRecipeRepository.ts`作成
    - [x] `findById`メソッド実装
    - [x] `findPublishedById`メソッド実装
    - [x] ~~`save`メソッド実装~~ (YAGNI原則により削除)
    - [x] ~~`incrementViewCount`メソッド実装~~ (YAGNI原則により削除)
    - [x] `search`メソッド実装
    - [x] `findPublishedRecipes`メソッド実装
    - [x] `findByBarista`メソッド実装
    - [x] `exists`メソッド実装
    - [x] `findByIds`メソッド実装
    - [x] `count`メソッド実装
  - [x] Prismaデータからドメインエンティティへのマッピング実装

- [x] **テスト用メモリリポジトリの実装** ✅ 完了 (2025-07-19)
  - [x] `MemoryRecipeRepository.ts`作成
  - [x] 全IRecipeRepositoryメソッドの実装（READ系のみ）
  - [x] テストデータの準備機能

#### Week 1（3-4日目）

- [x] **リポジトリテストの作成** ✅ 完了 (2025-07-19)

  - [x] PrismaRecipeRepositoryの統合テスト
  - [x] MemoryRecipeRepositoryの単体テスト
  - [x] データマッピングの正確性テスト
  - [x] RecipeMapperの単体テスト

- [x] **段階的移行の準備** ✅ 完了 (2025-07-19)
  - [x] 既存サービス層との並行運用設定
  - [x] ~~フィーチャーフラグの設定（必要に応じて）~~ (不要と判断)
  - [x] パフォーマンス監視の準備

---

## 📋 Phase 3: スキーマ分離パターンの確立 ✅ 完了 (2025-07-19)

### 優先度: 高

**背景分析完了**: `docs/wip-prompt.md`で特定されたエンティティ内バリデーション混在問題を解決するための追加フェーズ。

#### Week 3（1-2日目）

- [x] **Baristaエンティティのスキーマ分離** ✅ 完了 (2025-07-19)

  - [x] `BaristaSchema.ts`ファイル作成（統一バリデーションスキーマ）
  - [x] バリデーション関心事の完全分離
  - [x] 重複バリデーションロジック統合（4個のupdateメソッド→1個に統合）
  - [x] コード行数49%削減（295行→151行）

- [x] **Equipment・Recipeエンティティへの適用** ✅ 完了 (2025-07-19)

  - [x] `EquipmentSchema.ts`作成（包括的バリデーション定義）
  - [x] `Recipe.types.ts`作成（YAGNI原則により最小限実装）
  - [x] 各エンティティからのスキーマ分離完了
  - [x] Equipmentエンティティ34%削減（282行→185行）

- [x] **エンティティ別ディレクトリ構造への移行** ✅ 完了 (2025-07-19)
  - [x] barista/, equipment/, recipe/ディレクトリ作成
  - [x] 全エンティティファイルの適切な配置
  - [x] index.tsファイル作成（DRY原則によるエクスポート一元管理）
  - [x] 5ファイルのインポートパス更新
  - [x] 品質チェック完全通過

#### Week 3（2-3日目）

- [x] **テスト更新と品質保証** ✅ 完了 (2025-07-19)
  - [x] 分離されたスキーマの独立テスト追加（BaristaSchema: 22テスト、EquipmentSchema: 29テスト）
  - [x] エンティティテストの簡素化（ドメインロジック集中）
  - [x] 全テスト通過確認（570/571テスト成功）
  - [x] リンティング・型チェック完全通過

**実装成果**:

- ✅ 単一責任原則の徹底（4大原則適用）
- ✅ スキーマ再利用性の向上
- ✅ エンティティファイルの責任明確化
- ✅ テスタビリティの大幅向上
- ✅ 保守性・拡張性の向上

**新しいディレクトリ構造**:

```
src/server/domain/recipe/entities/
├── barista/          # Baristaエンティティ関連
├── equipment/        # Equipmentエンティティ関連
├── recipe/           # Recipeエンティティ関連
└── index.ts          # エクスポート一元管理
```

---

## 🎯 Phase 4: ユースケース分離 ✅ 完了（課題あり）

### 優先度: 中

#### Week 2（1-2日目）

- [x] **ユースケース層の実装** ✅ 完了 (2025-07-20)

  - [x] `GetRecipeDetailUseCase.ts`実装
    - [x] 依存注入の設定
    - [x] ビジネスロジックの実装
    - [x] エラーハンドリングの実装
  - [x] `SearchRecipesUseCase.ts`実装
    - [x] 検索ロジックの実装
    - [x] ページネーション処理
    - [x] フィルタリング機能

- [x] **DTOとレスポンス形式の実装** ✅ 完了 (2025-07-20)
  - [x] `RecipeDetailResponse.ts`作成
  - [x] `SearchRecipesResponse.ts`作成
  - [x] エンティティからDTOへの変換メソッド

#### Week 2（2-3日目）

- [x] **コントローラーのスリム化** ✅ 完了 (2025-07-20)

  - [x] `recipe/detail/controller.ts`リファクタリング
  - [x] `recipes/search/controller.ts`リファクタリング
  - [x] ユースケースの依存注入設定

- [x] **既存サービス層からの移行** ✅ 完了 (2025-07-20)
  - [x] 既存service.tsファイルの段階的削除
  - [x] 新しいユースケースへの完全移行
  - [x] 互換性テストの実行

**実装課題が発見**:

- ❌ TDD違反（プレースホルダーテスト）
- ❌ 型安全性の放棄（any型の使用）
- ❌ DRY原則違反（エラークラスの重複）
- 🔍 コードレビュー総合評価：6/10（要改善）

---

## 🚨 Phase 4.5: 品質改善（緊急対応）- 1-2日

### 🔥 緊急度: 最高

**背景**: Phase 4のコードレビューで発見された重要品質課題の解決

#### 即座実行タスク（必須）

- [ ] **TDD違反の解消**（最重要）

  - [ ] `GetRecipeDetailUseCase.test.ts`の実用テスト実装
    - [ ] 正常系テスト（公開レシピ取得、ビューカウント増加）
    - [ ] 異常系テスト（レシピ未存在、非公開、無効ID）
    - [ ] エッジケーステスト（境界値、高ビューカウント）
  - [ ] `SearchRecipesUseCase.test.ts`の実用テスト実装
    - [ ] 基本検索テスト（パラメータ、フィルター）
    - [ ] バリデーションテスト（無効パラメータ）
    - [ ] データ変換テスト（入力→ドメイン条件）
  - 期間: 1日

- [ ] **型安全性の修復**（高優先度）

  - [ ] `RecipeDetailResponseMapper`の型安全化
    - [ ] `any`型使用の完全排除
    - [ ] 適切な型定義とガード句
    - [ ] コンパイル時型チェック強化
  - [ ] `SearchRecipesResponseMapper`の型安全化
    - [ ] 同上
  - 期間: 0.5日

- [ ] **DRY原則違反の解決**（高優先度）
  - [ ] 共通エラーベースクラス`DomainError`作成
  - [ ] エラークラスの統一化
    - [ ] `RecipeDetailUseCaseError`
    - [ ] `SearchRecipesUseCaseError`
    - [ ] `RecipeDetailError`
  - [ ] 重複コードの統合
  - 期間: 0.5日

**成功基準**:

- ✅ 全テストが実用的で網羅的（placeholder testゼロ）
- ✅ 型エラーゼロ、any型使用ゼロ
- ✅ エラーハンドリングの一貫性確保
- ✅ `npm run format && npm run lint && npx tsc --noEmit && npm test`完全通過

---

## 📋 Phase 5: 完全統合とテスト強化 - 2-3日

### 優先度: 高

**目標**: 真のClean Architectureの実現

#### Week 3（1-2日目）

- [ ] **コントローラー直接統合**

  - [ ] サービス層の中間レイヤー除去
    - [ ] `recipe/detail/service.ts`の段階的削除
    - [ ] `recipes/search/service.ts`の段階的削除
  - [ ] ユースケースの直接呼び出し実装
    - [ ] コントローラーから直接ユースケース呼び出し
    - [ ] 依存性注入の最適化
  - [ ] 互換性確保とリグレッションテスト

- [ ] **包括的テスト実装**
  - [ ] ユースケース単体テスト（モック使用）
    - [ ] リポジトリモックによる分離テスト
    - [ ] ビジネスルール検証
  - [ ] リポジトリ統合テスト
    - [ ] 実際のデータベース接続テスト
    - [ ] データマッピング検証
  - [ ] エンドツーエンドテスト
    - [ ] API呼び出しから結果までの完全フロー
  - 期間: 1-1.5日

#### Week 3（2-3日目）

- [ ] **アーキテクチャ境界の強化**
  - [ ] 層間の依存関係検証
    - [ ] 依存関係グラフの作成
    - [ ] 不適切な依存の排除
  - [ ] 循環依存の排除
  - [ ] インターフェース分離の改善
    - [ ] `IRecipeRepository`の最適化
    - [ ] 不要メソッドの削除（YAGNI原則適用）
  - 期間: 0.5-1日

**Phase 5成功基準**:

- ✅ サービス層完全除去
- ✅ Clean Architectureの厳密な実装
- ✅ 90%以上のテストカバレッジ
- ✅ 全品質チェック通過

---

## 📋 Phase 6: エラーハンドリング統一 - 1-2日

### 優先度: 中

- [ ] **統一エラーシステム**

  - [ ] ドメインエラーの階層化
    - [ ] `DomainError`ベースクラス
    - [ ] `UseCaseError`、`RepositoryError`派生クラス
  - [ ] 一貫したエラーレスポンス形式
  - [ ] 国際化対応エラーメッセージ

- [ ] **ログ出力の標準化**
  - [ ] 構造化ログの統一
  - [ ] エラートレーシングの強化
  - [ ] 監視・アラート連携準備

---

## 📋 Phase 7: パフォーマンス最適化 - 1-2日

### 優先度: 低

- [ ] **クエリ最適化**

  - [ ] N+1問題の解決
  - [ ] インデックス戦略の見直し
  - [ ] キャッシュ戦略の実装

- [ ] **並行処理の最適化**
  - [ ] 非同期処理の改善
  - [ ] バッチ処理の効率化
