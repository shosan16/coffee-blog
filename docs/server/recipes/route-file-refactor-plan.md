# src/app/api/recipes/route.ts のファイル分割計画

## 現状の課題

現在の `route.ts` ファイルには、以下の複数の責務が混在しています：

1. Prismaクライアントの初期化とシングルトンパターンの実装
2. バリデーションスキーマの定義
3. リクエストパラメータの解析とバリデーション
4. クエリ条件の構築（where句）
5. データベースからのデータ取得
6. レスポンス形式への変換
7. エラーハンドリング

SOLID原則の単一責任の原則に従い、これらの責務を分割することで保守性と再利用性を向上させます。

## ファイル分割計画

### 1. Prismaクライアントの分離

**ファイル：** `src/db/prisma.ts`

Prismaクライアントの初期化とシングルトンパターンの実装を共通化します。これにより、アプリケーション全体で一貫したデータベース接続管理が可能になります。

### 2. バリデーションスキーマの分離

**ファイル：** `src/features/recipes/schemas/recipeQuerySchema.ts`

Zodを使用したバリデーションスキーマを分離します。これにより、他のエンドポイントや機能でも同じバリデーションルールを再利用できます。

### 3. リポジトリの作成

**ファイル：** `src/features/recipes/repositories/recipeRepository.ts`

データベースアクセスロジックを分離します。これにより、クエリロジックの再利用と単体テストが容易になります。

### 4. サービスレイヤーの作成

**ファイル：** `src/features/recipes/services/recipeService.ts`

ビジネスロジックを含むサービスレイヤーを作成します。リポジトリからデータを取得し、必要な変換やビジネスルールを適用します。

### 5. APIハンドラーの作成

**ファイル：** `src/features/recipes/api/recipesHandler.ts`

リクエスト処理とレスポンス形成のロジックを分離します。サービスレイヤーを呼び出し、適切なレスポンスを返します。

### 6. エラーハンドリングの共通化

**ファイル：** `src/shared/utils/apiErrorHandler.ts`

エラーハンドリングロジックを共通化します。これにより、一貫したエラーレスポンスフォーマットと処理が可能になります。

### 7. 型定義の整理

**ファイル：** `src/features/recipes/types/query.ts`

クエリパラメータに関連する型定義を整理します。既存の `api.ts` と組み合わせて使用します。

### 8. ルートハンドラーの更新

**ファイル：** `src/app/api/recipes/route.ts`

上記の分離されたモジュールを使用するように更新します。ルートハンドラーはシンプルになり、主要なロジックは各専門モジュールに委譲されます。

## anyの使用回避

現在のコードでは `where` と `orderBy` に `any` 型が使用されていますが、これはTypeScriptの型安全性を損なっています。以下の方法で改善します：

1. Prismaの型定義を活用した明示的な型付け
2. 必要に応じたユーティリティ型の作成
3. 型アサーションの慎重な使用

## 実装順序

1. Prismaクライアント分離
2. 型定義の整理
3. バリデーションスキーマの分離
4. リポジトリの作成
5. サービスレイヤーの作成
6. エラーハンドリングの共通化
7. APIハンドラーの作成
8. ルートハンドラーの更新

この順序で実装することで、依存関係の問題を最小限に抑えながら、段階的にリファクタリングを進めることができます。
