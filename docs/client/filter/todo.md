# コーヒーレシピフィルタリング機能 TODO

## フェーズ1: バックエンド拡張 ✅ 完了

- [x] waterAmountフィルターの実装 `進捗:100%` `✅`
  - **目的**: 総湯量での絞り込み機能を追加し、ユーザーが湯量でレシピを検索できるようにする
  - **詳細**: 既存のDBカラム`waterAmount`を使用したフィルタリング機能の実装
  - **依存**: なし
  - [x] SearchRecipesParamsにwaterAmountフィルターを追加
    - **内容**: `src/server/features/recipes/search/types.ts`に`waterAmount?: RangeFilter`を追加
    - **完了条件**: 型定義が追加され、TypeScriptエラーがないこと ✅
  - [x] 検索サービスにwaterAmountフィルタリングロジックを実装
    - **内容**: `src/server/features/recipes/search/service.ts`のPrismaクエリにwaterAmountの条件を追加
    - **完了条件**: 範囲指定（min/max）でのフィルタリングが動作すること ✅
  - [x] バリデーションの追加
    - **内容**: `src/server/features/recipes/search/validation.ts`にwaterAmountパラメータの検証を追加
    - **完了条件**: 不正な値（負の数、文字列など）が適切にエラーになること ✅
  - [x] ユニットテストの作成
    - **内容**: waterAmountフィルターのテストケースを追加
    - **完了条件**: 正常系・異常系のテストがすべてパスすること ✅

- [x] equipmentTypeフィルターの実装 `進捗:100%` `✅`
  - **目的**: 器具タイプ（コーヒーミル、ドリッパー、ペーパーフィルター）での絞り込み機能を追加
  - **詳細**: EquipmentTypeテーブルを使用した器具タイプでのフィルタリング
  - **依存**: なし
  - [x] SearchRecipesParamsにequipmentTypeフィルターを追加
    - **内容**: `src/server/features/recipes/search/types.ts`に`equipmentType?: string[]`を追加
    - **完了条件**: 型定義が追加され、TypeScriptエラーがないこと ✅
  - [x] 検索サービスにequipmentTypeフィルタリングロジックを実装
    - **内容**: equipment -> equipmentTypeのリレーションを使用したフィルタリング
    - **完了条件**: 複数の器具タイプでのOR検索が動作すること ✅
  - [x] バリデーションの追加
    - **内容**: equipmentTypeパラメータの検証（配列、文字列チェック）
    - **完了条件**: 不正な値が適切にエラーになること ✅
  - [x] ユニットテストの作成
    - **内容**: equipmentTypeフィルターのテストケースを追加
    - **完了条件**: 単一選択・複数選択のテストがパスすること ✅

## フェーズ2: フロントエンドUI実装 ✅ 完了

- [x] フィルター関連の型定義作成 `進捗:100%` `✅`
  - **目的**: フロントエンドで使用するフィルター関連の型を定義し、型安全性を確保
  - **詳細**: RecipeFilter型とその関連型の定義
  - **依存**: [waterAmountフィルターの実装] の完了後
  - [x] filter.tsファイルの作成
    - **内容**: `src/client/features/recipes/types/api.ts`にRecipeFilters型が定義済み
    - **完了条件**: RecipeFilter型が定義されていること ✅
  - [x] 既存の型定義との整合性確認
    - **内容**: サーバー側の型定義と矛盾がないか確認
    - **完了条件**: import/exportが正しく設定されていること ✅
  - [x] 定数の定義
    - **内容**: 器具タイプの選択肢、デフォルト値などの定数を各コンポーネントで定義
    - **完了条件**: すべての選択肢が定数として定義されていること ✅

- [x] useRecipeFilterフックの実装 `進捗:100%` `✅`
  - **目的**: フィルター状態の管理とURLクエリパラメータとの同期を行う
  - **詳細**: URLクエリパラメータとフィルター状態の双方向バインディング
  - **依存**: [フィルター関連の型定義作成] の完了後
  - [x] フックの基本実装
    - **内容**: `src/client/features/recipes/hooks/useRecipeFilter.ts`を作成
    - **完了条件**: フィルター状態の取得・更新ができること ✅
  - [x] URLクエリパラメータとの同期
    - **内容**: Next.jsのuseSearchParamsを使用した実装
    - **完了条件**: URLが変更されたときにフィルター状態が更新されること ✅
  - [x] デバウンス処理の実装
    - **内容**: 300msのデバウンスでAPIリクエストを最適化
    - **完了条件**: 連続した変更で過剰なリクエストが発生しないこと ✅
  - [x] リセット機能の実装
    - **内容**: すべてのフィルターをクリアする機能
    - **完了条件**: リセットボタンですべてのフィルターがクリアされること ✅

- [x] フィルターコンポーネントの作成 `進捗:100%` `✅`
  - **目的**: ユーザーがフィルター条件を選択できるUIを提供
  - **詳細**: 器具フィルターと抽出条件フィルターのコンポーネント群
  - **依存**: [useRecipeFilterフックの実装] の完了後
  - [x] RecipeFilterコンポーネントの作成
    - **内容**: `src/client/features/recipes/components/filter/RecipeFilter.tsx`を作成
    - **完了条件**: フィルター全体を管理するコンテナコンポーネントが動作すること ✅
  - [x] EquipmentFilterコンポーネントの作成
    - **内容**: 器具タイプ選択用のチェックボックスUI
    - **完了条件**: 複数選択が可能で、選択状態が正しく反映されること ✅
  - [x] ConditionFilterコンポーネントの作成
    - **内容**: 焙煎度、挽き目、各種範囲選択のUI
    - **完了条件**: すべての抽出条件が選択可能なこと ✅
  - [x] RangeSliderコンポーネントの作成
    - **内容**: 粉量、湯温、総湯量の範囲選択UI
    - **完了条件**: min/maxの値が正しく設定でき、視覚的にわかりやすいこと ✅
  - [x] コンポーネントテストの作成
    - **内容**: RecipeFilterコンポーネントのユニットテスト作成
    - **完了条件**: 基本的なユーザー操作のシミュレーションテストを作成 ✅

- [x] RecipeListコンポーネントの更新 `進捗:100%` `✅`
  - **目的**: 既存のRecipeListにフィルタリング機能を統合
  - **詳細**: フィルター状態に基づいたAPIリクエストの実装
  - **依存**: [フィルターコンポーネントの作成] の完了後
  - [x] フィルターコンポーネントの統合
    - **内容**: メインページ（page.tsx）にRecipeFilterコンポーネントを追加
    - **完了条件**: フィルターUIが表示されること ✅
  - [x] APIリクエストの更新
    - **内容**: 既存のuseRecipesフックがフィルター状態をクエリパラメータとして送信済み
    - **完了条件**: フィルター条件がAPIに正しく送信されること ✅
  - [x] ローディング状態の実装
    - **内容**: useRecipeFilterフックでローディング状態を管理
    - **完了条件**: フィルタリング中に適切なローディング表示がされること ✅
  - [x] 結果表示の更新
    - **内容**: フィルター結果の件数表示、空の状態の処理がRecipeListで実装済み
    - **完了条件**: フィルター結果が正しく表示されること ✅

## フェーズ3: UI/UX最適化

- [x] レスポンシブデザインの実装 `進捗:100%` `✅`
  - **目的**: モバイル・タブレット・デスクトップで最適な表示を実現
  - **詳細**: デバイスサイズに応じたフィルターUIの切り替え
  - **依存**: [RecipeListコンポーネントの更新] の完了後
  - [x] モバイル用UIの実装
    - **内容**: ドロワー形式でのフィルター表示を実装
    - **完了条件**: スマートフォンで使いやすいUIになっていること ✅
  - [x] タブレット用UIの調整
    - **内容**: 中間サイズでの最適なレイアウト
    - **完了条件**: iPadサイズで適切に表示されること ✅
  - [x] デスクトップ用UIの最適化
    - **内容**: サイドバー形式での表示を実装
    - **完了条件**: 大画面で効率的に操作できること ✅

- [x] ユーザビリティ機能の追加 `進捗:100%` `✅`
  - **目的**: フィルター操作の使いやすさを向上
  - **詳細**: 選択状態の可視化、操作のフィードバック
  - **依存**: [レスポンシブデザインの実装] の完了後
  - [x] フィルター適用状態の表示
    - **内容**: 適用中のフィルター数をバッジで表示
    - **完了条件**: フィルター数が一目でわかること ✅
  - [x] フィルタークリア機能の改善
    - **内容**: 一括クリア（リセット）機能を実装
    - **完了条件**: 直感的にフィルターをクリアできること ✅
  - [x] 基本的なアニメーション
    - **内容**: フィルター開閉時のCSS Transitionを実装
    - **完了条件**: スムーズな開閉動作が実装されていること ✅

- [x] パフォーマンス最適化 `進捗:100%` `✅`
  - **目的**: フィルター操作時のパフォーマンスを向上
  - **詳細**: 不要な再レンダリングの防止、メモ化の適用
  - **依存**: [ユーザビリティ機能の追加] の完了後
  - [x] コンポーネントのメモ化
    - **内容**: React.memo、useMemo、useCallbackの適用
    - **完了条件**: 不要な再レンダリングが発生しないこと ✅
    - **実装内容**:
      - RecipeFilter、ConditionFilter、EquipmentFilter、RangeSliderにReact.memo適用
      - イベントハンドラーをuseCallbackでメモ化
      - 計算処理をuseMemoでメモ化（アクティブフィルター数、タグ表示）
      - RecipeCardコンポーネントにもReact.memo適用
  - [x] 仮想スクロールの検討
    - **内容**: 現在のページネーション方式の評価と仮想スクロールの必要性判断
    - **完了条件**: 適切な実装方針の決定 ✅
    - **判断結果**: 現在はページネーション方式（各ページ20件程度）のため仮想スクロールは不要。将来的な大量データ対応時に再検討
  - [x] バンドルサイズの最適化
    - **内容**: 動的インポートの活用とコード分割
    - **完了条件**: 初期ロード時間が改善されること ✅
    - **実装内容**:
      - LazyRecipeFilterコンポーネント作成（動的インポート）
      - RecipeFilterを遅延読み込みに変更
      - ローディング時のスケルトンUI実装
      - メインページでLazyRecipeFilterを使用

## 実装完了事項

### shadcn/uiコンポーネントの追加

- [x] input.tsx
- [x] label.tsx
- [x] select.tsx
- [x] checkbox.tsx

### 作成したファイル一覧

```
src/client/features/recipes/components/filter/
├── RangeSlider.tsx          ✅ (React.memo適用済み)
├── EquipmentFilter.tsx      ✅ (React.memo適用済み)
├── ConditionFilter.tsx      ✅ (React.memo適用済み)
├── RecipeFilter.tsx         ✅ (React.memo適用済み)
├── RecipeFilter.test.tsx    ✅ (新規作成)
├── LazyRecipeFilter.tsx     ✅ (新規作成・動的インポート)
└── index.ts                 ✅ (新規作成)

src/client/features/recipes/hooks/
└── useRecipeFilter.ts       ✅ (新規作成)

src/client/features/recipes/components/
└── RecipeCard.tsx           ✅ (React.memo適用済み)

src/app/
└── page.tsx                 ✅ (LazyRecipeFilter適用済み)
```

### 実装済み機能

- **抽出器具フィルター**: コーヒーミル、ドリッパー、ペーパーフィルター、ケトル、スケールの複数選択
- **抽出条件フィルター**:
  - 焙煎度（6段階）の複数選択
  - 挽き目（7段階）の複数選択
  - 粉量の範囲指定（5-50g）
  - 湯温の範囲指定（70-100℃）
  - 総湯量の範囲指定（100-800ml）
- **URLクエリパラメータでの状態管理**: ブックマーク・共有可能
- **デバウンス処理**: 300msのデバウンスでAPI負荷軽減
- **レスポンシブデザイン**: モバイル（ドロワー）・デスクトップ（サイドバー）対応
- **UX機能**: フィルター数表示、リセット機能、ローディング状態

## 進捗サマリー

- **フェーズ1**: バックエンド拡張 - 2タスク ✅ **完了**
- **フェーズ2**: フロントエンドUI実装 - 4タスク ✅ **完了**
- **フェーズ3**: UI/UX最適化 - 3タスク ✅ **完了**

**全体進捗: 100% (9/9タスク完了)** 🎉
